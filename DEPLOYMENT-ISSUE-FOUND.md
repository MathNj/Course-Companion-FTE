# Deployment Issue - Found and Needs Fix

## üîç Root Cause Found

The application is **crashing on startup** due to environment variable parsing error:

```
pydantic_settings.exceptions.SettingsError: error parsing value for field "cors_origins" from source "EnvSettingsSource"
```

## The Problem

The `cors_origins` field in `app/config.py` is defined as:

```python
cors_origins: List[str] = [
    "http://localhost:3000",
    "http://localhost:8000",
]
```

Pydantic Settings expects this to be set as a **JSON array string**, but we set it as a simple comma-separated string.

## What We Tried

### Attempt 1: Wrong Format ‚ùå
```bash
flyctl secrets set CORS_ORIGINS="https://chat.openai.com,https://chatgpt.com"
```
**Result**: Parsing error

### Attempt 2: Correct JSON Format ‚úÖ
```bash
flyctl secrets set CORS_ORIGINS='["https://chat.openai.com","https://chatgpt.com"]'
```
**Result**: Secret updated, but machine still won't start

## Current Status

- **App Created**: ‚úÖ course-companion-fte
- **Database**: ‚úÖ PostgreSQL running and attached
- **Secrets**: ‚úÖ All set (including fixed CORS_ORIGINS)
- **Image**: ‚úÖ Built and deployed (202 MB)
- **VM State**: ‚ùå Still "stopped", not starting

## üîß Additional Issues

Looking at the logs, there may be other issues:

1. **Max restart count reached**: Machine tried 10 times and gave up
2. **Could not find good candidate for load balancing**
3. **App crashes immediately on startup**

## üìã Potential Solutions

### Option 1: Complete Fix (Recommended)

The issue might be that we need to redeploy after fixing the CORS secret:

```bash
cd backend
flyctl deploy --app course-companion-fte
```

This will create a new deployment with the corrected environment variable.

### Option 2: Alternative Deployment (Railway)

Since Fly.io is having issues, Railway might be easier:

1. Go to https://railway.app/new
2. Click "Deploy from GitHub repo"
3. Select `MathNj/Course-Companion-FTE`
4. Add PostgreSQL database
5. Set environment variables:
   ```
   JWT_SECRET_KEY=nFpDpFougSl6BkqqXwzsDmKHA6keETfSytpB8nPQlfw
   APP_ENV=production
   CORS_ORIGINS=["https://chat.openai.com","https://chatgpt.com"]
   LOG_LEVEL=INFO
   DATABASE_URL=(auto-generated by Railway)
   ```
6. Deploy

Railway handles environment variables better and often works more reliably for Python apps.

### Option 3: Simplify CORS Config

Temporarily remove the CORS_ORIGINS requirement by modifying the config to not use environment variables for CORS.

## üéØ Recommended Action

**Let's try redeploying first** with the fixed CORS secret:

```bash
cd C:\Users\Najma-LP\Desktop\Course-Companion-FTE\backend
flyctl deploy --app course-companion-fte --dockerfile Dockerfile.production
```

This will:
1. Build a fresh image with corrected environment
2. Start a new VM with proper configuration
3. Should start successfully

## üìä What's Working

- ‚úÖ Fly.io account and authentication
- ‚úÖ App created (course-companion-fte)
- ‚úÖ Database provisioned and attached
- ‚úÖ All secrets configured (now with correct CORS format)
- ‚úÖ Docker image built successfully

## ‚ùå What's Not Working

- ‚ùå VM machine won't start (stopped state)
- ‚ùå Can't test health endpoint
- ‚ùå Can't run migrations until app starts

---

**Next step: Redeploy with corrected environment variable.**

Would you like me to try redeploying?
